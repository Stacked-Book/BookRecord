# 액세스 회선을 통해 인터넷의 내부로

`학습할 것`

- ADSL 기술을 이용한 액세스 회선의 구조와 동작
- 광섬유를 이용한 액세스 회선(FTTH)
- 액세스 회선으로 이용하는 PPP와 터널링
- 프로바이더의 내부
- 프로바이더를 경유하여 흐르는 패킷

---------------------------------

# ADSL 기술을 이용한 액세스 회선의 구조와 동작

## 1. 인터넷의 기본은 가정이나 회사의 LAN과 같다.

- 사용자의 라우터에서 액세스 회선을 통해 인터넷에 연결된다.
- 인터넷의 내부에는 수만 대 이상의 라우터가 있고 다수의 라우터가 차례대로 수신처 IP 주소를 바탕으로 중계 대상을 판단하면서 패킷을 중계하여 목적지에 전달한다.
  - 중계장치 간의 거리가 머므로 이더넷 케이블(트위스트페어 케이블)이 아닌 광섬유 케이블을 사용한다.
  - 라우터에서 중계 대상을 판단할 때 사용하는 경로표가 자동화되어있다.

## 2. 사용자와 인터넷을 연결하는 액세스 회선

#### 라우터의 중계 동작

- 인터넷 접속용 라우터의 중계 동작은 이더넷 라우터와 거의 같다.
  - 패킷 IP 헤더에 기록된 수신처 IP 주소와 경로표의 수신처 항목을 대조하여 해당하는 경로를 찾아 중계 대상에 패킷을 송신하는 방식.
- **패킷 송신동작은 액세스 회선의 규칙에 따라 실행되므로 이더넷 규칙과 다르다.**

#### 액세스 회선이란?

- LAN을 연결하는 통신 회선을 뜻한다.
- 일반 가정의 경우, ADSL, FTTH 등을 액세스 회선으로 이용한다.

## 3. ADSL 모델에서 패킷을 셀로 분할한다.

#### ADSL이란?

- 전화선을 이용하여 컴퓨터가 데이터 통신을 할 수 있는 수단이다.

#### ADSL이 통신 되는 방식

1. 허브 -> 라우터 -> 인터넷 접속용 라우터
   - `| MAC | IP | 데이터 |`
   - 클라이언트에서 IP 헤더와 MAC 헤더를 붙인 패킷이 리피터 허브나 스위칭 허브를 경유하여 인터넷 접속용 라우터에 도착한다.
   - 인터넷 접속용 라우터는 이더넷 패킷에서 IP의 패킷을 추출하여 중계대상을 판단한다.
   - PPP, PPPoE, MAC의 각 헤더를 붙인다.
2. 인터넷 접속용 라우터 -> ADSL 모뎀
   - `| MAC | PPPoE | PPP | IP | 데이터 |`
   - ADSL 모뎀은 패킷을 수신하여 ATM 셀로 분할한다.
   - 이후 셀을 전기 신호로 변환하여 송출한다.
3. ADSL 모뎀 -> DSLAM (모뎀 집합)
   - DSLAM은 전기 신호를 수신 후 ATM 셀에 되돌려 송신한다.
4. DSLAM -> BAS (광대역 액세스 서버)
   - BAS는 ATM 셀을 수신하여 패킷의 형태로 되돌린다.
   - PPP 패킷을 추추하고 터널링용 헤더(L2TP 터럴링의 경우 L2TP 헤더)를 붙여 송신한다.
5. BAS -> 터널링용 라우터
   - `| L2TP | PPP | IP | 데이터 |`
   - 터널링용 라우터는 패킷을 수신하여 IP 패킷을 추출한다.
   - 이후 인터넷 내부를 향해 송신한다.
6. 터널링용 라우터 -> 인터넷
   - `| XXX | IP | 데이터 |`

**인터넷 접속용 라우터는 MAC 헤더, PPPoE 헤더, PPP 헤더를 붙여 ADSL 모뎀에 패킷을 보낸다. (PPPoE의 경우)**

## 4. ADSL은 변조 방식으로 셀을 신호화한다.

- ADSL 모뎀은 패킷을 작게 분할하여 셀에 저장한다.
- 이후 변조기술을 사용하여 신호로 변환한다.
- ADSL은 진폭 변조와 위상 변조 방식을 결합한 **직교진폭 변조** 방식을 사용한다.

#### 변조 기술이란?
- 완만한 파형(정현파)를 합성한 신호에 0과 1의 비트 값을 대응시키는 기술이다.

##  5. ADSL은 파를 많이 사용하여 고속화를 실현한다.

- ADSL은 다수의 파에 비트값을 대응시켜 고속화를 실현한다.
- 회선의 상태를 조사하여 사용할 파의 수나 각 파에 대응하는 비트 수를 판단하는데 모델의 전원을 공급할 때 시험 신호를 보내고 이 수신 상태에 따라 파의 수나 비트 수를 판단한다. 이를 `트레이닝`이라고 한다.

## 6. 스플리터의 역할

**ADSL의 신호는 전화의 음성 신호와 섞여서 전화 회선에 함께 흘러나간다. 스플리터는 주파수차이를 이용하여, 전화 신호와 ADSL의 신호를 나누는 역할을 한다**

- ADSL 모뎀에서 전기 신호로 변환된 셀은 스플리터 장치에 들어가게된다.
- 사용자측 신호를 전화 회선에 송출할 때는 그대로 흘리기만 한다. 
- 회선에서 신호가 들어왔을 경우 전화와 ADSL 신호를 분리하여 전화기 측에 ADSL 신호가 흐르지 않도록 한다.
- 일정한 주파수를 초과하는 신호를 차당하는 기능을 갖추고 있어 ADSL의 높은 주파수 신호를 차단하여 전화기에는 전화의 신호만 흐르고 ADSL 모뎀으로 향하는 신호는 그대로 흐른다. 
  - ADSL 모뎀 내부에는 ADSL에서 사용하는 주파수 외의 주파수를 차단하는 기능이 있기 때문이다.

## 7. 전화국 까지의 여정

- 스플리터 앞에는 전화 케이블을 꽂은 모듈형 커넥터가 있다.
- 이곳을 통과하여 옥내 배선을 지나 건물의 경우 배선반(IDF, MDF), 보안기를 지나 밖의 배선으로 흐른다.

## 8. 잡음의 영향

## 9. DSLAN을 통과하여 BAS에 도달한다.

- 전화 케이블을 통해 전화국에 도착한 신호가 배선반과 스플리터를 통과하여 DSLAM에 도착하면 전기 신호가 디지털 데이터의 셀로 복원된다.
  
#### DSLAN이란?

- 전화국용 ADSL 집합 모뎀으로 **다수의 ADSL 모뎀을 하나의 케이스에 넣은 기기**이다.
- 사용자측의 ADSL 모뎀은 이더넷 인터페이스를 가지고 있어 사용자 측의 라우터나 PC와 이더넷 패킷 형태로 송수신하지만 DSLAM은 이더넷 대신 ATM 인터페이스를 가지고 있어 패킷을 분할한 셀 형태로 후방의 라우터와 주고 받는다.
- 전기 신호를 수신하고 디지털 데이터의 셀로 복원하여 BAS에 송신한다.

#### 모뎀이란?

- 정보 전달을 위해 신호를 변조하여 송신하고 수신측에서 원래의 신호로 복구하기 위해 복조하는 장치이다.

#### BAS란?

- **패킷 중계 장치**이다.
- 셀로 분할된 패킷을 원래 패킷으로 복원한다.
- MAC 헤더와 PPPoE 헤더는 BAS 인터페이스에 패킷을 건네주기 위한 역할이므로 제거한다.
- 터널링용 헤더를 붙여 터널링 라우터로 송신한다.

#### 터널링용 라우터

- 터널링용 헤더를 분리하고 IP 패킷을 추출하여 인터넷 내부에 중계한다.

---------------------------------
# 광섬유를 이용한 액세스 회선(FTTH)

## 1. 광섬유의 기본

#### 광통신의 원리
- 디지털 데이터를 전압이나 전류라 바꾸고 광원에 입력한다.
- 광원은 전압이나 전류의 세기에 따라 발광하며 명암으로 정보를 전달한다.
- 빛은 광섬유 안에서 진행되어 수신측에 도착한다.
- 수신측은 수광소자를 이용하여 빛에 감응하고 밝기에 따라 전압을 일으킨다.

## 2. 싱글모드와 멀티모드의 차이

#### 싱글모드

- 코어에 1개의 빛을 이용하는 방식이다.
- 거리가 먼 경우에 사용한다. 거리가 멀어지면 신호의 변형이 일어나기 쉬우므로 싱글모드를 사용한다.

#### 멀티모드

- 코어에 2개 이상의 빛을 이용하는 방식이다.
- 더 많은 데이터를 사용할 수 있어 데이터 처리 속도가 빠르다.

## 3. 광섬유를 분기시켜서 비용을 절감한다.

- FTTH 액세스 회선의 형태는 크게 두가지로 나뉜다.
- 광섬유를 분기하지 않는 유형
  - 사용자측의 `미디어컨버터`장치에서 이더넷 전기 신호를 광신호로 변환한다.
  - 광신호는 미디어 컨버터에 연결된 광섬유로 들어간다.
  - BAS 바로 앞의 집합형 미디어 컨버터에 연결되어 광신호가 흘러간다.
- 광섬유를 분기하는 유형
  - 광섬유를 분기시키는 `광스플리터`를 사용해 복수의 사용자를 연결한다.
  - 미디어 컨버터 대신 `ONU 장치`
를 사용자 측에 설치하고 이더넷 신호를 광신호로 변환한다.
  - 이 신호는 BAS 바로 앞에 OLT 장치로 흘러간다.
  - OLT와 ONU에서는 패킷 충돌 방지를 위해 타이밍을 조정하는 기능이 있다.


---------------------------------
# 액세스 회선으로 이용하는 PPP와 터널링

- ADSL 이나 FTTH 등의 액세스 회선에서 인터넷을 향해 흘러온 패킷은 액세스 회선을 운영하는 사업자가 소유한 BAS에 도착한다.

## 1. 본인 확인과 설정 정보를 통지한다.

- BAS는 라우터와 달리 본인 확인과 설정값 통지 기능이 있다. 로그인 창구 역할을 하는데 이를 위해 PPPoE  구조를 사용한다.
- PPPoE는 PPP 구조의 발전된 형태이다.

####  PPP란? (Point to Point Protocol)

- 두 지점 간에 일대일 통신을 수행하는 프로토콜이며 사용자 인증 기능이 있다.
- 전화 회선이나 통신 회선을 사용하여 통신할 때 사용하는 구조이다.
- 본인확인, 설정값 통지, 데이터 압축, 암호화 등 다양한 기능 조합하여 사용 가능하다.

####  PPP 의 동작방식

1. 프로바이더의 액세스 포인트에 전화를 건다.
2. 전화가 연결되면 사용자명과 패스워드를 입력하여 로그인 조작을 한다.
3. 사용자명과 패스워드는 RADIUS라는 프로토콜을 사용하여 RAS(Remote Access Server)에서 본인 확인용 서버에 전송되어 검사받는다.
4. 검증이 완료되면 인증 서버에서 IP 주소 등의 설정 정보를 반송되므로 사용자 측에 전송한다.
5. 사용자 PC는 이 정보에 따라 IP 주소 등을 설정하여 TCP/IP의 패킷을 송수신할 준비가 된다.
6. 이후 TCP/IP 패킷 송수신 동작으로 넘어간다.

## 2. 이더넷에서 PPP 메시지를 주고받은 PPPoE

#### PPPoE란?
- PPP 메시지를 이더넷의 패킷에 넣어 주고받는 방식이다.

- PPP 프로토콜에는 이더넷의 프리앰블이나 FCS에 해당하는 규정이나 신호에 대한 규정이 없으므로 PPP 메시지를 그대로 신호로 변환하여 송신할 수 없다.
- 이 규정을 가지기 위해 `HDLC 프로토콜(High-level Data Link Control)` 사양을 차용하는데 ADSL이나 FTTH는 HDLC를 사용할 수 있는 형태가 아니므로 이너텟 패킷을 사용하여 PPP 메시지를 주고 받는다.


## 3. 터널링 기능에 의해 프로바이더에 패킷을 전달한다.

- BAS에는 터널링을 사용해 패킷을 운반한다.
- 프로바이더의 라우터 사이에 있는 ADSL/FTTH 접속 서비스 사업자의 네트워크 안에 터널을 만든다.

#### 터널링이란?
- 한쪽의 터널링 출입구에서 헤더를 포함한 패킷 전체를 넣으면 이것이 헤더를 포함하여 그대로의 모습으로 반대쪽 출입구에 도달하는 방식이다.

#### 터널링 실현 방식

- TCP 커넥션
  - 네트워크의 터널링용 라우터 사이에 TCP 커넥션을 만든다. 
  - 커넥션의 양끝에 있는 소켓에 해당하는 부분을 라우터의 포트로 간주하고 패킷을 송수신한다
  - 즉 패킷 송수신 시 터널링 규칙을 따라 터널에 패킷을 넣거나 꺼낸다.
- 캡슐화 방식
  - 헤더를 포함한 패킷 전체를 별도의 패킷 안에 저장하여 터널의 한쪽 출입구까지 운반한다

## 4. 액세스 회선 전체의 동작

1. 사용자측에 인터넷 접속용 라우터를 설치하고 인터넷에 접속한다.
2. 인터넷 접속용 라우터에 프로바이더가 할당한 사용자명과 패스워드를 등록한다.
3. 인터넷 접속용 라우터는 PPPoE를 기반으로 BAS를 찾는다. (BAS의 MAC 주소를 찾는다)
4. BAS에 사용자명과 패스워드를 보낸다.
   - 패스워드 암호화는 CHAP이나 PAP 방식이 있다.
5. BAS에서 패스워드를 확인하고 사용자에 대해 TCP/IP 정보를 통지한다.
   - 기기에 할당한 IP주소, DNS 서버의 IP 주소, 기본 게이트웨이 IP 주소
6. 인터넷 접속용 라우터에서 이 정보를 바탕으로 라우터 자체에 설정한다.
   - BAS측 포트에 글로벌 주소 할당하고 라우팅 테이블(경로표)에 기본 게이트웨이 설정
7. 인터넷 접속용 라우터는 패킷을 인터넷에 중계할 수 있는 상태가 된다.

## 5. IP 어드레스를 할당하지 않는 언넘버드

- 인터넷 접속용 라우터가 패킷을 송신할 때 부가하는 헤더의 값은 사전에 대부분 결정되어 있다.
- 라우터의 포트끼리 하나의 케이블로 연결하는 상태에서 접속되어 있는 부분에서는 한쪽에서 송신한 패킷은 예외없이 반대편에 도착하므로 경로표에서 게이트웨이 항목의 값을 바탕으로 중계 대상의 주소를 조사하는 동작은 필요 없다.
- 그러므로 일대일 형태로 접속된 포트에는 IP 주소를 할당하지 않아도 되고 이를 `언넘버드`라고한다.

## 6. 인터넷 접속용 라우터에서 프라이빗 주소를 글로벌 주소로 변환한다.

- BAS는 사용자 측에 TCP/IP 설정 정보를 통지하는데 이 설정 정보를 PC에 설정하면 글로벌 주소가 할당되어 주소 변환의 원리를 사용하지 않고 인터넷에 액세스 할 수 있다.
- 그러나 인터넷 접속용 라우터를 사용하면 BAS가 통지한 설정 정보를 라우터가 받아 글로벌 주소가 라우터에 할당된다.
- 이 경우 PC에는 프라이빗 주소를 할당하고 PC가 보낸 패킷은 인터넷 접속용 라우터에서 주소 변환 이후 인터넷에 중계된다.
- 주소변환을 쓰지 않으려면 라우터를 사용하지 않고 PC에 글로벌 주소를 할당하여 사용하는 방법도 있다.

## 7. PPPoE 이외의 방식

- 액세스 회선에는 PPPoE 외의 다양한 방식이 있다.

#### PPPoA 방법을 사용한 ADSL 액세스 회선

- PPPoA는 PPP 메시지를 그대로 셀에 저장한다.
- MAC 헤더와 PPPoE 헤더를 붙이지 않고 패킷을 그대로 저장한다.
  - PPPoE는 PPP 메시지를 이더넷 패킷에 저장한 후 셀에 저장한다.
- MAC 헤더가 붙어있지 않으므로 PPP 메시지를 그대로 이더넷에 전송할 수 없다.
  - BAS와 PPP 메시지를 주고받는 기기(PC 라우터)를 ADSL 모뎀과 일체화해야한다.

---------------------------------
# 프로바이더의 내부

#### 프로바이더란?

- 서비스를 제공하는 인터넷 통신사를 뜻한다.
- 프로바이더는 일종의 중계자 역할을 맡아 라우터로 이루어진 내부망을 종합하여 인터넷과 통신하는 역할을 수행한다.

> 인터넷은 한 개의 조직이 운영 관리하는 단일 네트워크가 아닌 다수의 프로바이더의 네트워크로 서로 접속한 것이다.

## 1. POP와 NOC

#### POP란? (Point of Presence)

-  ADSL이나 FTTH의 액세스 회선은 사용자가 계약한 프로바이더의 설비에 연결되어 있는데, 이 설비를 POP라고 부른다.
- 액세스 회선을 통과한 패킷은 프로바이더의 POP에 설치된 라우터에 도착한다.
  - 전용선을 이용한 액세스 회선 -> 통신 회선용 포트를 장착한 보통의 라우터 사용
  - 전화 회선이나 ISDN 회선 -> RAS 라우터 사용

#### NOC란? (Network Operation Center)

- 프로바이더의 핵심이 되는 설비로서 POP 에서 들어온 패킷이 여기에 모여든다.
- 이 곳에서 목적지 근처에 있는 POP나 다른 프로바이더로 패킷이 흘러가는데 여기에도 고성능 라우터가 설치되어 있다.

## 2. 건물 밖은 통신 회선 등으로 접속한다.

- 건물 안에서는 트위스트 페어 케이블이나 광섬유 케이블을 이용해 직접 접속하지만 멀리 떨어진 장소에 있는 NOC나 POP를 연결하는 방법에는 몇가지 변형이 있다.
- 광섬유를 소유하고 있는 프로바이더는 먼 장소에 있는 NOC나 POP를 연결하면 되지만 유지 관리 비용이 크다.
- 광섬유를 소유하지 않은 프로바이더는 통신 회선을 이용하여 NOC나 POP를 연결한다.

---------------------------------
# 프로바이더를 경유하여 흐르는 패킷

- POP의 라우터에 도착한 패킷의 움직임을 살펴보자

## 1. 프로바이더끼리의 접속

- 웹 서버가 클라이언트와 같은 프로바이더에 접속되어 있는 경우
  - 프로바이더의 라우터에는 라우터끼리 경로 정보를 교환하고 이것을 경로표에 자동으로 등록한다.
  - 경로 정보를 자동화하므로 경로표를 검색하면 중계 대상이 판명된다.
  - 중계 대상에 패킷을 보내고 같은 방법으로 중계 대상 판명 및 전송을 반복한다.
  - 패킷은 이 중 웹서버측의 POP에 설치한 라우터에 도착한다.
- 웹 서버가 클라이언트와 프로바이더가 다른 경우
  - 중계 대상이 경로표에 등록되어있다면 위의 동작과 동일하다.

## 2. 프로바이더끼리 경로 정보 교환하기

- 경로표에 경로 정보는 어떻게 등록이 될까?
- 프로바이더 간에 경로 정보를 교환하고 라우터에 자동 등록하는 방법을 살펴보자.

#### AS (Autonnomous System)

- 하나의 관리 집합 내의 라우터들의 집합을 의미한다.
- AS는 관계를 기준으로 두가지로 분류된다.
  - inter-AS : AS와 AS 간의 관계를 의미하며 IGP(Interior Gateway Protocol)라고 불리기도 한다. ex) OSPF
  - intra-AS : 하나의 AS 내의 라우터끼리 관계를 의미한다. ex) BGP

#### BGP (Border Gateway Protocol)

<img src= "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbxsCs4%2FbtraVTwLzvE%2FCbvGBD9yyjJsj4tjkM5Lt1%2Fimg.png" width="600">

출처 : https://ddongwon.tistory.com/97?category=801335

- AS의 가장자리에 위치한 BG (Border Gateway)들 간의 프로토콜을 의미한다.
- 다른 AS들에 속한 BG 간의 연결에도 관여하지만 같은 AS 내의 BG 간의 연결에도 관여한다.
  - iBGP : 서로 같은 AS 상의 BG들 끼리의 연결을 담당한다.
  - eBGP : 서로 다른 AS 상의 BG들 끼리의 연결을 담당한다.

- 예시를 통해 BGP의 동작과정을 살펴보자.

  <img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FUfRFe%2FbtraWUhTdEF%2FqC6u1HhpKkUu6j5UNTq3Mk%2Fimg.png" width="600">

  1. AS2에 존재하는 BG(192.32.7.0) 가 자신과 연결된 AS1에게 메시지를 보낸다. 
     - 메시지에는 AS2의 IP 주소 (192.32.0.0/21)가 담겨있으며 해당 IP 주소로 접근하기 위해 가야하는 경로 AS2를 함께 보낸다.
  2. AS1에 존재하는 두개의 BG(202.32.1.0, 202.32.9.0) 사이에 BGP 메시지를 보낸다.
      - 메시지를 통해 AS1의 다른 BG(202.32.9.0) 가 목표 IP 주소(192.32.0.0/21) 로 접근하기 위해 가야하는 경로인 AS2를 알게 된다.
  3. AS1과 인접한 AS3의 BG에게 BGP 메시지를 보낸다. 
      - 메시지를 통해 AS3의 BG(143.248.5.0) 는 목표 IP 주소(192.32.0.0/21) 와 해당 주소로 접근하기 위해 가야하는 경로인 AS1 AS2를 알게된다.
  > BGP 메시지를 주고받는 와중에 Intra-AS 프로토콜인 OSPF나 RIP를 통해 해당 AS 내의 모든 라우터들이 다른 AS에 존재하는 IP 주소를 서로 공유하고, 경로를 설정하게 되므로 AS 내에 존재하는 BG가 아닌 일반적인 라우터들 또한 다른 AS에 존재하더라도 패킷을 보낼 수 있다. 

## 3. 사내 네트워크에서 자동 등록하기

- 사내에서 사용하는 구조는 목적지까지의 최단 경로를 찾아 패킷을 중계하도록 설정되어있다.
- 프로바이더의 경우 액세스하는 목적지의 최단 경로로 패킷을 보내는 구조를 사용할 경우 다른 프로바이더의 패킷이 회선에 유입될 수 있고 이는 비용 교섭을 할 수 없게된다.
- 인터넷의 경우 단순히 최단 경로를 선택하지 않고 의도하지 않은 상대로부터 오는 패킷을 중지하는 구조가 필요하다.
  - 경로 정보를 교환하는 상대를 지정하면 사내에서는 무차별적으로 모든 라우터와 경로 정보를 교환하지만 프로바이더 간의 경로 정보 교환은 특정 라우터와 일대일로 이루어진다.

## 4. IX의 필요성 (Internet eXchange)

- 프로바이더끼리 일대일 형태로 접속하는 것이 기본동작이나 이는 모든 프로바이더와 통신회선을 연결해야한다.
- 중심이 되는 설비인 IX를 설치하고 이 것을 경유하여 접속하는 방법을 선택하면 모든 프로바이더와 패킷을 교환할 수 있다.

## 5. IX에서 프로바이더끼리 접속하는 모습

- IX의 중심에는 고속 LAN의 인터페이스를 다수 장착한 레이어 2 스위치가 있다.
- L2 스위치의 기본 동작은 스위칭 허브와 같다. 여기에 프로바이더의 라우터를 연결한다.
- IX의 스위치는 라우터에서 패킷을 송신할 때 ARP에서 중계 대상 라우터의 인터페이스의 MAC주소를 조사하여 이것을 MAC 헤더에 기록하여 패킷을 보낸다.
- 프로바이더는 서로 합의된 상대와 경로 정보를 교환하고 패킷을 주고받는다.

> L2 스위치 : 패킷의 MAC 주소를 읽어 스위칭한다.