## 들어가기 전에

---

*ref.* [https://minkwon4.tistory.com/288](https://minkwon4.tistory.com/288)

### 허브(더미 허브, 리피터 허브)

- OSI 7계층 중에서 1계층인 **물리 계층**에서 동작하는 장치
- 단점 : **모든 포트에 데이터를 전송**하므로 과도한 트래픽 발생
- 단점을 극복하기 위해 스위치(스위칭 허브)를 사용

<br>

### 스위치(스위칭 허브, L2 스위치)

- OSI 2계층인 **데이터링크 계층**에서 동작하는 장치
- 랜을 구성할 때 사용하는 단말기 간 스위칭 기능이 있는 통신망 중계장치
- 내부에 MAC 주소 테이블을 포함하여 포트 번호와 해당 포트에 연결되어 있는 MAC 주소가 등록되어 있음
- 컴퓨터에서 같은 네트워크 내의 **특정한 다른 단말기로 패킷을 보낼 수 있는 기능** 제공

<br>

### 라우터


- OSI 3계층인 **네트워크 계층**에서 동작하는 장치
- 서로 다른 네트워크를 연결해 주는 장치로 현재의 네트워크에서 다른 네트워크로 패킷을 전송하는 기능 제공
- **라우팅 테이블**을 이용하여 경로 정보를 등록하고 관리

<br>

### 전체 과정 요약

① 송신할 패킷을 `LAN 어댑터`의 `PHY(MAU) 회로`에서 전기 신호로 형태를 바꾼다.

② `RJ-45 커넥터`를 통해 `트위스트 페어 케이블(꼰 선쌍)`에 들어가 신호가 흘러나간다.

③-1 **`리피터 허브` 경유 시**

- 그 후 신호는 케이블 속을 흘러 리피터 허브의 커넥터 부분에 도착한다.
- 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다.
- 신호를 수신한 기기는 MAC 헤더의 주소를 조사하여 자신이 수신처에 해당하면 수신한다.

③-2 **`스위칭 허브` 경유 시**

- 신호가 커넥터 부분에 도착한다.
- 주소표에서 수신처 MAC 주소를 찾아 포트를 찾고 `스위치 회로`를 경유하여 패킷을 송신측의 포트로 보낸다.

③-3 **스위칭 허브에 리피터 허브가 접속되어있을 시**

- 리피터 허브에서 패킷을 모든 포트에 송신한다.
- 스위칭 허브는 패킷을 수신한 포트와 송신하는 포트가 같을 경우 패킷을 중계하지 않고 폐기한다.

④ `라우터`에 패킷이 도착하고 라우터는 다음 라우터로 중계한다.

<br>

## 01 케이블과 리피터, 허브 속을 신호가 흘러간다

---

### 트위스트 페어 케이블

> 통신 오류의 원인이 되는 송출 신호의 변형을 방지하기 위한 대책으로 ‘트위스트 페어(꼰 쌍)’, 즉 신호선을 마주 꼬아서 잡음을 막는다.
>

<br>

**잡음의 원인과 해결법**

- **외부 요인** : 모터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파
    - 전자파의 진행 방향의 오른쪽으로 전류가 생기면서 파형을 무너뜨린다.
    - **해결법** : 신호선을 꼬아 형태를 나선형으로 만들어 인접한 선의 전류 방향을 반대로 설정하면 잡음을 상쇄할 수 있다.
- **내부 요인** : 같은 케이블 안의 인접한 신호선에서 누설되는 전자파
    - 신호선 안에 흐르는 전류에 의해 주위에 전자파가 생성되는데 이 잡음에 의한 영향을 `크로스토크(crosstalk)`라고 한다.
    - **해결법** : 꼬는 간격을 미묘하게 변화시켜 어떤 부분에서는 플러스 신호가 가까이 있고 다른 부분에서는 마이너스 신호선이 가까워지게 한다.

      → 플러스와 마이너스의 균형을 잡아 잡음의 영향을 줄인다.


<br>

### 리피터 허브

> 전체에 패킷의 신호를 뿌리고 수신처 MAC 주소에 해당하는 기기만 패킷을 수신한다.
>

<img width="718" alt="스크린샷 2022-06-17 오후 7 33 47" src="https://user-images.githubusercontent.com/80027033/174300423-bc03d694-d2a1-4b97-aa7c-e6a2f820f6a4.png">

- 신호를 제대로 수신하기 위해 신호선을 교차 시켜 ‘송신 단자’에서 보낸 신호를 ‘수신 단자'로 받게 한다.
- 리피터 허브 끝의 커넥터에는 MDI/MID-X라는 전환 스위치가 있다.
    - MDI : RJ-45 커넥터와 송수신 회로를 직접 결선
    - MDI-X : 교차하여 결선하는 것(크로스 케이블)

<br>

**중계 과정**

① 리피터 허브에서 `PHY(MAU)회로`에 수신부에 신호가 도달한다.

② PHY(MAU) 회로가 들어오는 신호를 리피터 허브의 커넥터 부분에 송출한다.

③ 신호는 리피터 허브에 접속한 전체 기기에 도달한다.

④ 신호를 수신한 기기는 `MAC 헤더`에 쓰여있는 수신처 MAC 주소를 조사하여 자신이 수신처에 해당하면 수신하고, 해당하지 않으면 신호를 무시한다.

💡 *만약, 신호가 최종 도착지에 도달하여 디지털 데이터로 변환되고 FCS 단계에서 데이터변화가 판명되면 변화된 패킷은 폐기되고 프로토콜 스택의 TCP 담당 부분이 패킷을 재전송한다.*

<br>

## 02 스위칭 허브의 패킷 중계 동작

---

<img width="473" alt="스크린샷 2022-06-17 오후 7 53 35" src="https://user-images.githubusercontent.com/80027033/174300573-06ced13f-77dc-478a-a8d3-a854e25f8371.png">

- **MAC 주소표**

  MAC 주소와 포트 번호를 등록한 테이블로 해당 주소가 어느 포트에 접속되어 있는지 판단할 수 있다.

- 스위칭 허브는 동시에 여러 개의 패킷을 중계할 수 있다.

<br>

**중계 과정**

① 신호가 커넥터 부분에 도달하여 PHY(MAU) 회로에 수신된다.

② 패킷에 오류가 없으면 수신처 MAC 주소를 검사하지 않고 버퍼 메모리에 저장한다.

③ MAC 주소표에서 수신처 MAC 주소와 일치하는 것이 등록되어 있는지 조사하고 등스

④ `스위치 회로`를 경유하여 패킷을 송신측의 포트에 보낸다.

⑤ MAC 회로나 PHY(MAU) 회로가 송신하고 케이블에 신호를 흘린다.

- 신호 송수신 회로의 수신 부분에 신호가 흘러들어오지 않는 것을 확인하고 아무도 송신하지 않으면 소켓을 디지털 데이터에서 신호로 변환하여 송신한다.

💡 **스위치 회로**

입력 포트와 출력 포트를 연결한 전자 회로로 전자적 개폐를 통해 신호가 흐르는 대상을 제어한다.

<br>

**MAC 주소 테이블 등록 및 갱신**

- 등록
    - 패킷을 수신할 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 하나와 하나의 세트로 MAC 주소표에 등록
- 갱신 및 삭제
    - 일정 시간이 경과하면 MAC 주소표의 내용을 삭제
    - MAC 주소표 내용의 갱신이 필요할 때도 기기를 리셋하면 새롭게 주소가 등록되므로 수동 갱신 필요 X

<br>

**전이중 모드의 특징**

- 송신할 때 신호가 흐르고 있어도 끝나기를 기다릴 필요가 없다.
- 양방향으로 동시에 송신할 송신할 수 있으므로 송신할 수 있는 데이터 양의 상한선이 높아 성능이 좋다.

<br>

### **자동 조정**

> 접속한 상대가 전이중 모드를 지원하는지 검출하고 동작 모드를 자동으로 전환하는 기능으로 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환이 가능하다.
>
- `링크 펄스` : 데이터의 흐름 상황을 확인하기 위한 펄스형의 신호
- 이더넷 기기의 초록 LED 표시등을 통해 PHY(MAU) 회로와 케이블의 이상 유무를 확인할 수 있다.

<br>

**예시**

***조건 :***

- LAN 어댑터 : 모든 속도와 동작 모드를 지원
- 스위칭 허브 : 100메가비트/초의 전이중 모드만 지원

***과정 :***

① 두 기기의 전원을 켜고 하드웨어의 초기화 동작을 끝낸다.

② 자체에서 지원하는 속도와 동작 모드를 펄스 신호로 보낸다.

③ 신호가 상대에게 도착하며, 도착한 펄스의 패턴을 읽고 상대가 어느 모드를 지원하는지 조사한다.

④ 우선순위가 높고 양쪽 모두 지원하는 전송속도와 동작모드가 자동으로 조정되어 동작한다.

<br>

## 03 라우터의 패킷 중계 동작

---

**라우터의 구성**

- 중계 부분

  중계 대상을 판단하는 동작 담당

- 포트 부분

  패킷을 송수신하는 동작 담당

- 라우팅 테이블

  등록된 정보에 의해 중계 대상을 판단하여 패킷을 중계

<br>

**중계 과정**

① 포트 부분에서 패킷을 수신한다.

포트 부분이 이더넷이라면 이더넷의 규칙에 따라, 무선 LAN이라면 그에 따라 동작

- 신호가 커넥터 부분에 도착하면 PHY(MAU) 회로와 MAC 회로에서 신호를 디지털 데이터로 변환한다.
- FCS를 대조해 오류 유무를 점검한다.
- 정상이면 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사하여 해당하면 패킷을 수신 버퍼 메모리에 저장한다.(아니라면 해당 패킷 폐기)
- 수신 동작이 끝난 후, MAC 헤더를 폐기한다.

② 중계 부분에서 받은 패킷의 `IP 헤더`에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조하여 중계 대상을 판단한다.

- ‘게이트웨이' 항목에 IP 주소가 쓰여있으면 해당 주소가 건네줄 대상이고 비어있으면 IP 헤더의 수신처 IP가 대상이 된다.
- IP 주소가 결정되면 ARP로 MAC 주소를 조사해 설정한다.

③ 중계 대상측의 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행한다.

<br>

**라우팅 테이블/경로표**

<img width="690" alt="스크린샷 2022-06-17 오후 8 29 47" src="https://user-images.githubusercontent.com/80027033/174300798-9eb6af5a-978b-45f7-9047-c86b1be7d674.png">

- `주소 집약`을 이용하면 여러 개의 서브넷을 모아 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있다.
- **넷마스크** : 경로표의 수신처와 패킷의 수신처 주소를 대조할 때의 비트 수
    - 넷마스크 항목의 `0.0.0.0`인 행은 ‘기본 경로'를 나타낸다.
- **게이트웨이** : 등록되어 있는 IP 주소를 가진 라우터 파악
- **인터페이스** = 포트
- **메트릭** : 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지 표현
    - 수가 클수록 멀다.

→ **수신처**와 **넷마스크**에서 해당 행을 찾아내면 **인터페이스** 항목의 `포트`에서 **게이트** 항목에 등록되어 있는 IP 주소를 가진 `라우터`에 패킷을 중계한다.

<br>

**예시**

***조건 :***

- PC - 10.10.1.101
- 서버 - 192.168.1.10

***과정 :***

① 넷마스크로 네트워크 주소 부분을 파악해 192.168.1이 중계 대상의 후보라고 파악한다.

② 3, 4, 5행의 3개가 복수의 후보로 파악되면 네트워크 번호의 비트 수가 가장 긴 것을 찾는다.

- 자동으로 호스트 번호의 비트 수가 짧아지므로 서브넷이 작은 후보를 선택하면 중계 대상을 정확하게 판단할 수 있다.
- 3행은 192.168.1.0/255.255.255.0으로 ‘서브넷'을 나타내며, 4행은 서브넷 안에 있는 192.168.1.10/255.255.255.255라는 ‘서버'를 나타내므로 4행을 선택한다.
- 네트워크 번호의 길이가 같은 것이 여러 행 존재한다면 메트릭 값으로 판단한다.

③ 패킷을 송신하기 전에 IP 헤더의 TTL(Time To Live, 생존 기간) 필드 값을 줄인다.

💡 해당하는 행이 하나도 없다면 해당 패킷을 폐기하고 ICMP 메시지로 송신처에 이 사실을 통지한다.

💡 TTL 값을 1씩 줄여 0이 되면 패킷의 생존 기간이 만료되는 것으로 간주하여 패킷을 폐기하는데 이것은 패킷이 같은 장소를 계속해서 순환하는 사태를 방지하기 위함이다. 송신처가 처음 패킷을 송신할 때 64 또는 128로 값을 설정한다.

<br>

**조각 나누기(fragmetation)**

> 중계하는 패킷의 크기가 출력측의 패킷 최대 길이를 초과하면 패킷을 분할하고 패킷의 길이를 짧게 만든 후 중계한다.
>

<img width="585" alt="스크린샷 2022-06-17 오후 9 13 58" src="https://user-images.githubusercontent.com/80027033/174300898-fd18d923-7394-4d4b-8251-fc338c3b9387.png">

① 출력측의 MTU를 조사해서 패킷을 그대로 송신할 수 있는지 조사한다.

② MTU가 작은 경우, IP 헤더의 플래그 필드를 확인해 분할해도 좋을지 확인한다.

③ 분할 불가일 경우 패킷을 폐기하고 ICMP 메시지를 송신하고 그렇지 않으면 출력측의 MTU에 맞춰 데이터 부분을 맨 앞부분부터 차례대로 잘라낸다.

<br>

## 04 라우터의 부가 기능

---

- **주소 변환**
    - 주소 부족에 대처하기 위해 고유 주소인 `글로벌 주소`와 사내용 주소인 `프라이비트 주소`를 사용한다.
        - `프라이비트 주소` : 기존 글로벌 주소에 포함되어 있던 주소 중에 범위를 정하고, 사내에서 사용한다고 약속한 것.
    - 사내 네트워크에는 프라이비트 주소를 할당하고 인터넷과 직접 패킷을 주고받지 않도록 한다.
        - 송신처의 IP 주소를 글로벌 주소로 바꾸고 바꿔쓰기 전의 프라이비트 주소/포트번호, 바꿔쓴 후의 글로벌 주소/포트번호를 한 세트로 하여 `주소 변환 장치` 내부에 있는 대응표에 기록해 둔다.
- **패킷 필터링**
    - 부정 침입을 방지하기 위해 패킷을 중계할 때 MAC, IP, TCP 헤더에 기록되어 있는 내용을 조사하여 사전에 설정한 조건에 합치되면 패킷을 중계하거나 폐기한다.