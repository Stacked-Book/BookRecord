# 케이블과 리피터, 허브속을 신호가 흘러간다

#### 하나하나의 패킷이 독립된것으로 동작한다 

- 컴퓨터에서 송신된 패킷은 허브,라우터에 의해 목적지를 향해 진행하는데 이때 패킷 헤더의 제어정보, 중계장치 내부에있는 중계대상의 표를 목적지로 판단하여 중계한다

- 패킷은 TCP의 수신확인이나 시퀀스번호, HTTP메시지 , 등 모두 무시하고 목적지만을 향해 중계된다

#### LAN 케이블은 신호를 약화시키지 않는것이 핵심이다 

![](https://velog.velcdn.com/images/dudwls0505/post/b679c373-5acb-4c79-b7f2-68a3a1c98532/image.png)



- LAN어댑터의 PHY회로에서 전기신호로 패킷의 형태가 바뀌고, RJ-45커넥터를 통해 꼰 선쌍에 들어가게된다 

- 케이블의 길이가 길어질수록 신호가 약해지며 변형될 여지가 있다

#### '꼼'은 잡음을 방지하기위한 방법이다 

- LAN케이블로 사용하는 꼰 선쌍이 잡음에 대한 대책이 될수있고, 케이블의 성능이 향상될수있다.

- 케이블의 주위에서 발생하는 전자파, 누설되는 전자파가 잡음의 원인이다

- 잡음 방지를 위해 신호선 사이의 거리를 유지하기위해 신호선 사이에 구분판을 넣거나 , 전자파를 차단하기위해 피복을 입히는등의 대책도 케이블의 성능을 향상시킬수있는 방법이다 


#### 리피터 허브는 연결되어있는 전체 케이블에 신호를 송신한다

![](https://velog.velcdn.com/images/dudwls0505/post/e55a0194-99ae-4136-a35c-d04416f0962d/image.png)

- 리피터 허브는 연결된 케이블 전부에 신호를 송신한다 

- 리피터 허브 내부엔 PHY회로와 역할이 같은 회로가 있다 제대로 수신하기 위해 송신단자에서 수신단자로 받도록 해야한다 이때문에 신호선을 교차시켜 접속하게된다 

- 리피터허브의 끝 커넥터에 MDI/MDI-X 와 같이 쓰여있는 전환스위치가 있는데 MDI-X 는 교차하여 결선하게된것이고 MDI는 RJ-45커넥터와 신호 송수신회로를 직접 결선한것이다 

- 허브끼리 접속할땐 한쪽을 MDI로 설정해야하고 모든 커넥터가 MDI-X인경우엔 크로스케이블로 허브들을 접속한다 

- 신호가 커넥터를 뚫고 나가서 리피터 허브에 접속한 전체기기에 도달하고 신호를 수신한 기기는 MAC헤더의 수신처 주소를 참고하여 해당하면 수신하고 해당하지않으면 무시한다 

> 정리
 송신된 패킷은 패킷에 포함되어있는 다른정보들은 무시한채 목적지만을 향해 중계된다    
LAN어댑터는 '꼼'으로 잡음을 방지하고 케이블의 성능의 향상을 도모한다   
리피터 허브는 전체기기에 신호를 전달하고 수신한기기는 MAC헤더를 참고하여 자신이 해당하면 목적지를 향해 그 신호를 수신한다 


# 스위칭 허브의 패킷중계동작

#### 스위칭 허브는 주소테이블로 중계한다 
- LAN어댑터는 MAC주소를 확인하고 해당하지않은경우 패킷을 폐기하지만, 스위칭허브의 포트는 수신처 MAC주소를 검사하지않고 모든패킷을 수신하여 버퍼메모리에 저장하기때문에 스위칭 허브의 포트에는 MAC주소가 할당되어있지않다. 

- 버퍼메모리에 저장하면 MAC주소표를 참고해 MAC주소와 일치하는것이 있는지 조사하여 알아낸뒤 스위치 회로를 경유하여 송신측포트에 보냅니다  

- 스위칭허브는 MAC주소표에서 MAC주소를 조사하여 해당하는 포트에서 신호를 송신한다

![](https://velog.velcdn.com/images/dudwls0505/post/757d5bf7-18f3-4ee0-bdf7-6aa2b1be7b42/image.png)

예를들어 수신한 패킷의 수신처 MAC주소가 00-02-B3-1C-9C-F9 라면 8번포트에 주소가 있다는걸 알수있다 . 이경우 8번포트가 송신측 포트가 된다 

- 누군가가 송신중이면 끝날떄까지 기다리고 아무도 송신하지않으면 소켓을 디지털 데이터에서 신호로 변환하여 송신한다. 

- 송신중에도 수신신호를 감시하고 이때 재밍신호를 보낸후 송신동작을 중지하고 잠시기다렸다가 
다시보낸다


#### MAC 주소 테이블을 등록 및 갱신한다

- 스위칭허브는 패킷을 수신하면 송신처 MAC주소를 조사하고 이것을 수신한 입력포트번호와 세트로 MAC주소표에 등록한다

- 일정시간이 경과된 MAC주소표에 등록된정보를 삭제한다 

- MAC주소표의 내용은 스위칭허브가 자체적으로 등록/수정/삭제한다 

#### 예외적인 동작

![](https://velog.velcdn.com/images/dudwls0505/post/0680d986-d38d-4868-b65d-b86bc07f9894/image.png)


- 리피터허브에 의해 모든포트에 뿌려진 패킷이 스위칭허브를 통해 같은곳에 한번더 패킷이 도착하게되는 상황이 있을수있는데 스위칭허브는 패킷을 수신한 포트와 송신하는 포트가 같을경우 패킷을 중계하지않고 폐기한다

- MAC주소표에 수신처 MAC주소와 일치하는 주소가 없는경우(시간경과 등의 이유로) 혹은 수신처의 MAC주소가 브로드캐스트 주소인경우 , 패킷을 수신한 포트 이외의 전체포트에 패킷을 송신한다

#### 전이중 모드에서 송신과 수신을 동시에 실행한다

- 트위스트 페어케이블의 신호선은 송신용,수신용으로 나누어져있어  신호가 충돌하지않는다
=> 리피터 허브를 사용하면 신호는 충돌하지않게된다 

- 전이중모드는  송신할때 신호가 흐르고있어도 송신이 끝나길 기다릴필요가 없다.
 이는 반이중모드 보다 빠르게 동작하며 양방향 동시송신이 가능해 성능이 좋다 
 
 #### 최적의 전송속도로 보내는 자동조정 
 
 - 이더넷에선 데이터가 흐르고있지않을때 링크펄스라는 신호를 흘려 케이블의 단선유무, 상대가 올바르게작동하는지 확인할수있다. 
 
 - 펄스신호를 이용해 동작확인용으로만 사용했는데 자동조정 기능이 생겨 펄스신호를 패턴으로 이용해 지원가능한모드(전이중, 반이중) 와 전송속도를 통지할수있게 되었다
 
 #### 스위칭 허브는 복수의 중계동작을 동시에 실행한다
 
 - 리피터허브는 들어온신호를 모든포트에서 뿌리므로 동시에 두개이상 신호가 들어오면 패킷이 충돌하기때문에 복수의 신호를 동시에 흘릴수없다
 
 - 스위칭허브는 동시에 신호를 컨트롤할수있기때문에 기기전체에서 중계할수있는 패킷의 수가 리피터허브보다 많다
 

 
 
 # 라우터의 패킷중계동작 
 
 #### 라우터의 기본
 
 
 ![](https://velog.velcdn.com/images/dudwls0505/post/ce353308-cc9e-4522-9355-6ddfb47ee8be/image.png)
 
 - 라우터 내부에는 중계부분과 포트부분이 있다. 중계부분은 패킷의 중계대상을 판단하게 되고 포트부분이 패킷을 송수신하는 동작을 담당한다
 

 - 라우터의 중계부분은 IP담당부분과 같고 포트부분은 LAN어댑터와 같다고 생각하면 된다 

 - 포트부분의 특정 통신기술에 의존하지않으며 , 동작은 통신기술의 규칙에 따른다
 => 무선LAN이면 무선LAN의 규칙, 통신회선이면 통신회선의 규칙에 따라 동작함
 
 

#### 경로표에 등록된 정보

![](https://velog.velcdn.com/images/dudwls0505/post/022f03c3-f658-4f29-a99d-8a8381409029/image.png)


- 스위칭허브는 MAC주소로 중계대상을 판단하지만 라우터는 IP주소로 중계대상을 판단한다 

- 경로표에 등록된 IP주소와 수신한 패킷의 수신처 IP주소를 비교한다 

![](https://velog.velcdn.com/images/dudwls0505/post/c12b1a9c-37bc-4172-ad6c-ff3d801e862b/image.png)


- 주소집약 이라는것을 통해 복수의 서브넷을 하나로 간주하고 주소표를 작성할수있다


  - 수신처, 넷마스크 항목에서 해당행을 찾아내면 등록된 인터페이스에 게이트웨이 항목에 등록되어있는 IP주소를 가진 라우터에 대해 패킷을 중계한다   
  
  - 매트릭은 수신처 IP주소에 기록되어있는 목적지가 가까운지 먼지 기록하는 지표이다 작을수록 목적지와 가까운 것
  
  
#### 라우터의 패킷 수신 동작 

- 라우터의 포트에는 맥주소가 할당되어있으며, 자신의 주소에 해당하는 패킷만 수신하고자신의주소에 해당하지 않는 패킷은 폐기한다

#### 경로표를 검색하여 출력 포트를 발견한다

- 주소에 해당하는 패킷만 수신하고 나면 MAC헤더를 폐기하고 이제 IP헤더의 내용을 보고 목적지를 향해 패킷을 중계해야한다

-  IP헤더의 내용을 보기위해 경로표를 확인하고 넷마스크 항목에 네트워크 번호의 비트수를 판단한다 
> 192.168.1.10이라는 서버에 보낸 패킷이 라우터에 들어온경우, 
넷마스크의 네트워크번호부분만을 비교하여 수신처 항목이 일치하면 중계대상이 된다
  
- 복수의 후보가 발견되면 네트워크 번호의 비트수가 가장 긴 (호스트번호의 비트수가 짧은) 쪽을 선택한다 
=> 호스트번호의 비트수가 짧은것은 할당가능한번호의 수가 적다는것

#### 해당하는 경로가 없는경우 선택하는 기본경로

- 그림의 마지막행에있던 0.0.0.0의 비밀 = 중계대상을 전부 등록한것
=> 넷마스크 항목을 0.0.0.0으로하면 모든주소에 일치한다 

- 이 행은 게이트웨이 항목에 인터넷으로 나가는 라우터를 등록해두면 그곳으로 패킷을 중계하며, **기본경로**라고하고 여기에 등록한 라우터를 **기본 게이트웨이**라고 한다 

#### 큰 패킷은 조각 나누기 기능으로 분할한다

- 회선이나 LAN의 종류에 따라 패킷의 최대길이가 달라 패킷의 크기가 출력측의 패킷 최대길이를 초과하는 경우엔 그대로 패킷을 송신할수없다

- TCP가 데이터를 조각하는것과 달리(패킷에 데이터를 저장하기전에 이루어짐) IP프로토콜에 규정된 조각나누기라는 방법을 사용한다 
=> 출력측의 MTU를 조사하여 패킷을 그대로 송신할수있는지 조사하고 이때, 헤더의길이는 빼고 조사한다   

=> 분할하지않고 송신할수있으면 분할하지않고, 분할해야한다면 IP헤더의 플래그필드를 조사해서 분할해도 좋을지를 확인한다 . 분할할수있다면 맨앞부분부터 차례대로 잘라내고 기존의 IP헤더를 복사하여 붙여넣는다 분할할수없다면, 패킷을 폐기한다 

![](https://velog.velcdn.com/images/dudwls0505/post/082505fe-0a5a-400f-999b-5b778aa8391e/image.png)


#### 라우터의 송신동작은 컴퓨터와 같다 

- 라우터가 다음목적지를 판단하는 방법
=> 게이트웨이 항목에서 패킷을 건네줄 상대를 판단하고, 그곳에 IP주소가 쓰여있다면 그곳을 목적지로 설정하고 비어있다면 IP헤더의 수신처가 목적지가 된다 

- ARP를 사용해 다음목적지의 MAC주소를 조사한다 

#### 라우터와 스위칭 허브의 관계 

- 통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고, 이 과정중 하나인 다음 라우터 까지 패킷을 운반하는 부분은 이더넷(스위칭허브)이 담당한다



# 라우터의 부가기능

#### 주소변환으로 IP주소를 효율적으로 이용한다 


예전에는 각 기기별로 주소를 할당하는 방법을 사용했으나

A와 B라는 완전히 독립된 네트워크가 구축된다고 가정했을때 (왕래할 일이 없는 관계)
A사의 서버에 할당한 주소와 같은주소를 B사의 클라이언트에 할당해도 
패킷을 건네줄 대상을 찾기 못하게되는일이 없어졌다. 

같은주소를 사용하더라도 네트워크가 독립되어있다면 이런문제가 발생하지 않게되었다
단지 프라이빗주소(사내용주소) , 글로벌주소( 이전의 고유한 주소방식)로 나눠서 할당한다는 규칙만 존재했다.

프라이빗 주소의 범위는 글로벌 주소에 포함되어있던 범위중 일부범위를 사용하기로한 규약에 불과하다
![](https://velog.velcdn.com/images/dudwls0505/post/3124291f-0170-486f-b9e9-a9c1570f2fea/image.png)


사내 네트워크는 인터넷을 통하면 많은 회사와 연결되므로 패킷이 독립되었다고 볼수가 없기때문에 
패킷을 정확하게 운반하지못할 경우가 생길수도있다.   

그래서 위그림과같이 인터넷에 공개하는 서버를 접속하는부분, 사내용 네트워크 2가지로 나누게되었다. 
이때 공개용서버엔 글로벌주소를 , 사내 네트워크에는 프라이빗주소를 할당한다 

이 구조를 주소변환이라고 한다


#### 주소변환의 기본동작

- 패킷을 중계할때 IP헤더에 기재된 IP주소와 포트번호를 바꿔쓰는것 
- TCP 접속동작 과정에서 패킷을 인터넷에 중계할때 송신처의 IP주소를 프라이빗 주소에서 글로벌 주소로 바꿔쓰고 포트번호도 바꿔쓴다  ( 포트번호는 라우터가 알아서 선택한다)
- 바꾸기전,후의  프라이빗주소,포트번호를 표에 기록해둔다   
  
![](https://velog.velcdn.com/images/dudwls0505/post/fcb46cb6-a834-4709-ae15-b440e9f45009/image.png)   



- 대응표를 참조해서 글로벌 주소,포트번호를 찾아 수신처와 대응되는 프라이빗주소, 포트번호로 바꿔쓰고 내부 네트워크에 패킷을 보낸다 

- 접속 동작이 끝나면 대응표에 등록한것을 삭제한다

#### 포트 번호를 바꿔쓰는 이유

1:1로 대응하여 인터넷에 접속한다면 문제가 없지만
동시에 여러 직원이 액세스 한다면 포트번호 하나에 대응하는 여러개의 글로벌 주소가 필요하기때문에
포트번호 변경하여 사용하는것을 고안하였다

이렇게되면 한개의 글로벌주소를 수만개의 프라이빗 주소에 대응시킬수있다(?) => 효율이 높아진다(?)

#### 인터넷에서 회사로 액세스한다

-인터넷에서 사내로 패킷을 중계할때는 반드시 대응표에 등록이 되어있어야한다
=> 글로벌과 프라이빗주소의 대응관계를 판단할수 없기때문

- 사전에 수동으로 대응표에 등록해두거나, 사내에서 인터넷으로 액세스 해야만 패킷을 송신할수있다.

#### 라우터의 패킷 필터링 기능

- MAC,IP,TCP 헤더의 내용을 조사하여 조건에 부합하면 패킷을 중계하거나 폐기한다
=> 대부분의 방화벽의 원리도 이와 같다
